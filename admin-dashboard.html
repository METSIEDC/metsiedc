<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | MET'S IEDC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { admin: { red: '#ef4444', dark: '#991b1b' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #ffffff; overflow-x: hidden; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .glass-sidebar { background: rgba(10, 5, 5, 0.9); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-header { background: rgba(5, 5, 5, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s ease; }
        .glass-input:focus { background: rgba(255, 255, 255, 0.08); border-color: #ef4444; outline: none; }
        .sidebar-link { transition: all 0.3s ease; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .sidebar-link.active { background: rgba(239, 68, 68, 0.1); color: #f87171; border-left-color: #f87171; }
        .custom-checkbox { appearance: none; background-color: rgba(255,255,255,0.1); width: 1.25em; height: 1.25em; border: 1px solid rgba(255,255,255,0.3); border-radius: 0.25em; cursor: pointer; display: inline-grid; place-content: center; }
        .custom-checkbox:checked { background-color: #ef4444; border-color: #ef4444; }
        .custom-checkbox:checked::before { content: "✔"; color: white; font-size: 0.8em; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body class="font-sans antialiased relative flex h-screen overflow-hidden">

    <aside class="glass-sidebar w-64 flex-shrink-0 hidden md:flex flex-col h-full z-20">
        <div class="p-6 flex items-center gap-3">
            <img src="assets/images/logos/MSEM.jpg" alt="Logo" class="w-10 h-10 rounded-full border-2 border-red-500/50">
            <div>
                <span class="block text-lg font-bold text-white leading-tight">IEDC Admin</span>
                <span class="text-xs text-red-400 font-medium uppercase">Control Panel</span>
            </div>
        </div>
        <nav class="flex-grow px-4 py-4 space-y-2 overflow-y-auto">
            <button onclick="showTab('overview')" id="nav-overview" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-r-lg text-gray-400 text-sm font-medium">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Overview
            </button>
            <button onclick="showTab('users')" id="nav-users" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-r-lg text-gray-400 text-sm font-medium">
                <i data-lucide="users" class="w-5 h-5"></i> Manage Users
            </button>
            <button onclick="showTab('announcements')" id="nav-announcements" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-r-lg text-gray-400 text-sm font-medium">
                <i data-lucide="bell" class="w-5 h-5"></i> Post Updates
            </button>
            <button onclick="showTab('certificates')" id="nav-certificates" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-r-lg text-gray-400 text-sm font-medium">
                <i data-lucide="award" class="w-5 h-5"></i> Issue Certificates
            </button>
            <button onclick="showTab('eventForms')" id="nav-eventForms" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-r-lg text-gray-400 text-sm font-medium">
                <i data-lucide="file-plus" class="w-5 h-5"></i> Create Forms
            </button>
        </nav>
        <div class="p-4 border-t border-white/5">
            <button id="adminLogoutBtn" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-lg text-sm font-medium">
                <i data-lucide="log-out" class="w-4 h-4"></i> Secure Logout
            </button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col h-full overflow-hidden relative z-10">
        <header class="glass-header h-20 flex items-center justify-between px-6 md:px-10 shrink-0">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">Admin Dashboard</h1>
            <div class="text-right"><p class="text-sm font-medium text-white" id="adminEmailDisplay">Loading...</p></div>
        </header>

        <main class="flex-grow overflow-y-auto p-6 md:p-10">
            
            <div id="overviewSection" class="tab-content space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-red-500">
                        <p class="text-gray-400 text-xs uppercase mb-1">Total Users</p>
                        <h3 class="text-3xl font-bold text-white" id="totalUsersCount">0</h3>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-yellow-500">
                        <p class="text-gray-400 text-xs uppercase mb-1">Announcements</p>
                        <h3 class="text-3xl font-bold text-white" id="totalAnnouncementsCount">0</h3>
                    </div>
                </div>
            </div>

            <div id="usersSection" class="tab-content hidden space-y-6">
                <div class="glass-card rounded-2xl overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="bg-white/5 text-white"><tr><th class="px-6 py-4">Name</th><th>Email</th><th>Role</th></tr></thead>
                        <tbody id="userListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="announcementsSection" class="tab-content hidden max-w-2xl mx-auto">
                <div class="glass-card p-8 rounded-3xl">
                    <h2 class="text-2xl font-bold text-white mb-6">Broadcast Update</h2>
                    <form id="announcementForm" class="space-y-4">
                        <input type="text" id="annTitle" class="glass-input w-full rounded-xl py-3 px-4" placeholder="Subject" required>
                        <textarea id="annContent" rows="4" class="glass-input w-full rounded-xl py-3 px-4" placeholder="Details" required></textarea>
                        <button type="submit" class="w-full bg-red-600 py-3 rounded-xl font-bold">Publish</button>
                    </form>
                </div>
            </div>

            <div id="certificatesSection" class="tab-content hidden space-y-6">
                <div class="glass-card p-8 rounded-3xl">
                    <h2 class="text-2xl font-bold text-white mb-6">Issue Certificates</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <input type="text" id="certEventName" class="glass-input w-full rounded-xl py-3 px-4" placeholder="Event Name">
                        <input type="date" id="certDate" class="glass-input w-full rounded-xl py-3 px-4">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-400 text-sm mb-2">Upload Template (PNG/JPG)</label>
                        <input type="file" onchange="handleCertTemplate(event)" class="text-sm text-gray-400">
                        <p id="certFileName" class="mt-2 text-xs"></p>
                    </div>
                    <div class="glass-card rounded-xl overflow-hidden max-h-60 overflow-y-auto mb-6">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="bg-white/5"><tr><th class="px-4 py-2">Select</th><th>Name</th></tr></thead>
                            <tbody id="certUserListBody"></tbody>
                        </table>
                    </div>
                    <button onclick="issueCertificates()" id="certBtn" class="w-full bg-yellow-600 py-3 rounded-xl font-bold">Issue to Selected</button>
                </div>
            </div>

            <div id="eventFormsSection" class="tab-content hidden max-w-2xl mx-auto">
                <div class="glass-card p-8 rounded-3xl">
                    <h2 class="text-2xl font-bold text-white mb-6">Create Event Registration Form</h2>
                    <form id="formBuilderForm" class="space-y-4">
                        <input type="text" id="formTitle" class="glass-input w-full rounded-xl py-3 px-4" placeholder="Form Title" required>
                        <input type="text" id="formWebhook" class="glass-input w-full rounded-xl py-3 px-4" placeholder="Google Script Webhook URL" required>
                        <p class="text-[10px] text-gray-500 italic">This form will automatically sync responses to your Google Sheet via the provided script.</p>
                        <button type="submit" class="w-full bg-green-600 py-3 rounded-xl font-bold">Create Form</button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        const firebaseConfig = {
          apiKey: "AIzaSyAIn9hB7Hx4Nwwk5Ar9bE3tFuo40VkBcc8",
          authDomain: "metsiedc-3010e.firebaseapp.com",
          projectId: "metsiedc-3010e",
          storageBucket: "metsiedc-3010e.firebasestorage.app",
          messagingSenderId: "954403413150",
          appId: "1:954403413150:web:2523a3377f15a3d6002f8f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let certTemplateBase64 = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('adminEmailDisplay').textContent = user.email;
                    initSync();
                } else { signOut(auth).then(() => window.location.href = 'admin.html'); }
            } else { window.location.href = 'admin.html'; }
        });

        function initSync() {
            // Real-time Users
            onSnapshot(collection(db, "users"), (snap) => {
                document.getElementById('totalUsersCount').textContent = snap.size;
                let userHtml = '';
                let certHtml = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    userHtml += `<tr class="border-b border-white/5"><td class="px-6 py-4 text-white">${u.name}</td><td>${u.email}</td><td>${u.role}</td></tr>`;
                    if(u.role === 'student') {
                        certHtml += `<tr><td class="px-4 py-2"><input type="checkbox" class="cert-checkbox" value="${doc.id}" data-name="${u.name}"></td><td>${u.name}</td></tr>`;
                    }
                });
                document.getElementById('userListBody').innerHTML = userHtml;
                document.getElementById('certUserListBody').innerHTML = certHtml;
            });

            // Real-time Announcements
            onSnapshot(collection(db, "announcements"), (snap) => {
                document.getElementById('totalAnnouncementsCount').textContent = snap.size;
            });
        }

        // ISSUE CERTIFICATES LOGIC
        window.handleCertTemplate = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => { certTemplateBase64 = event.target.result; document.getElementById('certFileName').textContent = "Template Loaded ✅"; };
            reader.readAsDataURL(e.target.files[0]);
        };

        window.issueCertificates = async () => {
            const eventName = document.getElementById('certEventName').value;
            const date = document.getElementById('certDate').value;
            const selected = document.querySelectorAll('.cert-checkbox:checked');
            if(!eventName || !certTemplateBase64 || selected.length === 0) return alert("Complete all fields");

            const btn = document.getElementById('certBtn');
            btn.disabled = true; btn.textContent = "Processing...";

            try {
                for (const box of selected) {
                    await addDoc(collection(db, "certificates"), {
                        userId: box.value,
                        userName: box.getAttribute('data-name'),
                        eventName, date,
                        templateUrl: certTemplateBase64,
                        issuedAt: Date.now()
                    });
                }
                alert("All Certificates Issued!");
            } catch (err) { alert(err.message); } finally { btn.disabled = false; btn.textContent = "Issue to Selected"; }
        };

        // FORM BUILDER LOGIC
        document.getElementById('formBuilderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, "eventForms"), {
                    title: document.getElementById('formTitle').value,
                    webhook: document.getElementById('formWebhook').value,
                    active: true,
                    createdAt: Date.now()
                });
                alert("Form Configuration Saved!");
                e.target.reset();
            } catch (err) { alert(err.message); }
        });

        // BROADCAST LOGIC
        document.getElementById('announcementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, "announcements"), {
                    title: document.getElementById('annTitle').value,
                    content: document.getElementById('annContent').value,
                    timestamp: Date.now()
                });
                alert("Broadcast Sent!");
                e.target.reset();
            } catch (err) { alert(err.message); }
        });

        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId + 'Section').classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
        };

        document.getElementById('adminLogoutBtn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>
